# Development
This build system uses separate virtual environments for build tools and
application.

The `dev` venv contains all build tools, linters and other development only packages.
The package list is stored in `.ci/requirements.txt`.

The `app` venv contains run-time only dependencies of the project, as specified in
`pyproject.toml` file.

The complete build sequence, suitable for CI, is this

```sh
make build
make test
make lint-all
make upload
```

## Building
Below is a list of the available commands:
 * `make build` - builds python wheel and stores it in `dist/` directory. The
   build back-end is [pdm](https://github.com/pdm-project/pdm)
 * `make test` - uses [tox](https://tox.wiki/en/latest/) to run tests in isolated venvs
 * `make lint-all` - runs [pre-commit](https://pre-commit.com/) on all files.
 * `make lint` - runs [pre-commit](https://pre-commit.com/) on staged files only
 * `make upload` - uploads wheel to a PYPI server

If you want to run some development tool separately, you can do it with `.ci/venv run`
command. For example:

```sh
.ci/venv --name=dev run flake8 src/
.ci/venv --name=dev run pip install smth
```

If your application defined some scripts in `pyproject.toml`, you can run them
with below commands

```sh
# run once, local (editable) pip install
make einstall
# run after code change
.ci/venv --name=app run script
```

### Configure `pre-commit`
Currently enabled hooks:
 * [pre-commit-hooks](https://github.com/pre-commit/pre-commit-hooks)
   does general house keeping
 * [ruff](https://github.com/astral-sh/ruff)
   python linter and fixer. Super fast
 * [black](https://github.com/psf/black)
   ultimate python code formatter
 * [flake8](https://github.com/PyCQA/flake8)
   python linter
 * [shfmt](https://github.com/mvdan/sh)
   shell script formatter, enabled for bash only
 * [markdownlint](https://github.com/igorshubovych/markdownlint-cli)
   markdown linter and fixer
 * [pyspelling](xx)
   spell checker for both code and documentation

To make linting process more verbose, add `V=1` to lint commands

```sh
make lint V=1
make lint-all V=1
```

You can update [pre-commit](https://pre-commit.com/) hooks to the latest version
automatically by running below command. By default, this will bring the hooks
to the latest tag on the default branch.

```sh
.ci/venv run pre-commit autoupdate
```

#### Configure `pyspelling`
The configuration is stored in the file `docs/pyspelling.yml` and is as follows
 * scans markdown files `*.md`
 * scans python files `*.py`, looking only at `__doc__` strings
 * ignores code blocks defined in markdown style.<br> This way python
   in-code documentation can add code snippets (by putting them between
   triple-backticks " \`\`\` ") or component references (by putting them
   between single backticks " \` ")
 * uses `hunspell`. To install it run:
   ```sh
   sudo apt install hunspell hunspell-en-us
   ```
 * supports private dictionary. Project can add its own word list to the
   dictionary `docs/hunspell-en-custom.txt` using `hunspell` format.

## Update build scripts
This project was generated by [cruft](https://cruft.github.io/cruft/) using
[pdk-cookiecutter](https://github.com/aanatoly/pdk-cookiecutter/) template.
You can always update build scripts boilerplate by running

```sh
.ci/venv run cruft check
.ci/venv run cruft update
```

---
[![pre-commit](https://img.shields.io/badge/pre--commit-enabled-brightgreen?logo=pre-commit)](https://github.com/pre-commit/pre-commit)
[![cookie-cutter](https://img.shields.io/badge/cookie--cutter-enabled-brightgreen?logo=cookiecutter)](https://github.com/cookiecutter/cookiecutter)
[![Ruff](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/charliermarsh/ruff/main/assets/badge/v2.json)](https://github.com/charliermarsh/ruff)
